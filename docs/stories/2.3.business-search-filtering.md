# Story 2.3: Business Search & Filtering

## Status
Approved

## Story
**As a** consumer,
**I want** to search for businesses by name, category, or service and filter results,
**so that** I can quickly find specific types of businesses that meet my needs.

## Acceptance Criteria
1. Text search functionality searches business names, descriptions, and service keywords
2. Category filtering allows selection of business types (restaurants, retail, services, health, automotive, etc.)
3. Multiple filters can be combined (location + category + keyword) to narrow results
4. Search suggestions appear as user types, showing matching business names and popular categories
5. Filter options show result counts to help users understand available choices
6. Clear filter/reset functionality returns to unfiltered view
7. Search results maintain sort options (distance, rating, recently added)
8. Empty search results provide helpful suggestions and nearby alternatives

## Tasks / Subtasks
- [ ] **Task 1: Text Search Backend Implementation** (AC: 1)
  - [ ] Enhance GET /businesses endpoint with text search parameters
  - [ ] Implement full-text search using PostgreSQL text search capabilities
  - [ ] Add search indexing for business names, descriptions, and services
  - [ ] Create search ranking algorithm for relevance scoring
  - [ ] Implement fuzzy matching for typos and partial matches
  - [ ] Add search result highlighting for matched terms
  - [ ] Create search analytics and popular query tracking

- [ ] **Task 2: Category Filtering System** (AC: 2, 5)
  - [ ] Create business category enumeration and taxonomy
  - [ ] Implement category-based database filtering
  - [ ] Add category hierarchy support (main category > subcategory)
  - [ ] Create category result count aggregation
  - [ ] Implement multiple category selection (OR logic)
  - [ ] Add category icon and display name mapping
  - [ ] Create category popularity tracking and ordering

- [ ] **Task 3: Advanced Filtering Logic** (AC: 3, 6)
  - [ ] Implement combined filter logic (location + category + text)
  - [ ] Create filter state management and URL parameter handling
  - [ ] Add filter validation and conflict resolution
  - [ ] Implement filter persistence across app sessions
  - [ ] Create filter preset saving and quick access
  - [ ] Add clear all filters functionality
  - [ ] Implement filter breadcrumb display

- [ ] **Task 4: Search Suggestions and Autocomplete** (AC: 4)
  - [ ] Create search suggestion endpoint with typeahead support
  - [ ] Implement business name autocomplete with fuzzy matching
  - [ ] Add popular category suggestions based on user location
  - [ ] Create search history and personalized suggestions
  - [ ] Implement trending searches and popular queries
  - [ ] Add suggestion caching for performance
  - [ ] Create suggestion analytics and improvement tracking

- [ ] **Task 5: Frontend Search Interface** (AC: 1, 4, 6)
  - [ ] Create SearchBar component with autocomplete dropdown
  - [ ] Implement debounced search input for performance
  - [ ] Add search suggestion selection and handling
  - [ ] Create search history display and management
  - [ ] Implement voice search integration (optional)
  - [ ] Add search loading states and error handling
  - [ ] Create search result highlighting and snippets

- [ ] **Task 6: Filter UI Components** (AC: 2, 3, 5, 6)
  - [ ] Create FilterPanel component with category selection
  - [ ] Implement filter chips/tags for active filters display
  - [ ] Add result count display for each filter option
  - [ ] Create filter dropdown menus with search functionality
  - [ ] Implement range filters (distance, price, rating)
  - [ ] Add filter quick actions and presets
  - [ ] Create responsive filter design for mobile/desktop

- [ ] **Task 7: Search Results Management** (AC: 7, 8)
  - [ ] Implement search result sorting options (distance, rating, relevance)
  - [ ] Create sort dropdown with user preference persistence
  - [ ] Add search result pagination with infinite scroll
  - [ ] Implement empty state with helpful suggestions
  - [ ] Create "nearby alternatives" for no results scenarios
  - [ ] Add search result export and sharing functionality
  - [ ] Implement search result bookmarking

- [ ] **Task 8: Performance and Caching** (AC: 1, 4)
  - [ ] Implement search result caching with intelligent cache invalidation
  - [ ] Add search query optimization and index usage monitoring
  - [ ] Create search performance metrics and monitoring
  - [ ] Implement search suggestion caching and preloading
  - [ ] Add client-side result caching for improved UX
  - [ ] Create search analytics dashboard for business insights
  - [ ] Implement A/B testing framework for search improvements

## Dev Notes

### Previous Story Insights
Story 2.2 (Location-Based Discovery) established the foundation for location-aware business search. This story builds upon that with advanced text search, filtering, and user experience enhancements.

### Database Full-Text Search Context
[Source: architecture/backend-architecture.md + database-schema.md]
**PostgreSQL Full-Text Search Implementation:**
```sql
-- Add full-text search columns
ALTER TABLE businesses ADD COLUMN search_vector tsvector;

-- Create full-text search index
CREATE INDEX idx_businesses_search ON businesses USING GIN(search_vector);

-- Update search vector with business data
UPDATE businesses SET search_vector =
  setweight(to_tsvector('english', name), 'A') ||
  setweight(to_tsvector('english', description), 'B') ||
  setweight(to_tsvector('english', array_to_string(categories, ' ')), 'C') ||
  setweight(to_tsvector('english',
    COALESCE((services::jsonb ->> 'name'), '')), 'D');

-- Search query with ranking
SELECT *,
       ts_rank(search_vector, plainto_tsquery('english', $1)) as rank,
       ST_Distance(...) / 1000 as distance_km
FROM businesses
WHERE search_vector @@ plainto_tsquery('english', $1)
  AND is_active = TRUE
ORDER BY rank DESC, distance_km ASC;
```

### Enhanced API Specification Context
[Source: architecture/api-specification.md]
**Enhanced Business Search Endpoint:**
```typescript
GET /businesses?search={query}&category={categories}&latitude={lat}&longitude={lng}&radius={miles}&sort={field}&limit={n}&offset={n}

// Search suggestion endpoint
GET /businesses/suggestions?q={partial_query}&location={lat,lng}

// Category aggregation endpoint
GET /businesses/categories?location={lat,lng}&radius={miles}
```

### Business Categories Taxonomy
**Predefined Business Categories:**
```typescript
enum BusinessCategory {
  RESTAURANTS = 'restaurants',
  RETAIL = 'retail',
  SERVICES = 'services',
  HEALTH = 'health',
  AUTOMOTIVE = 'automotive',
  BEAUTY = 'beauty',
  FITNESS = 'fitness',
  ENTERTAINMENT = 'entertainment',
  PROFESSIONAL = 'professional',
  HOME_SERVICES = 'home_services'
}

interface CategoryInfo {
  id: BusinessCategory;
  name: string;
  icon: string;
  subcategories?: string[];
}
```

### Search State Management Context
**Search and Filter State:**
```typescript
interface SearchState {
  query: string;
  categories: BusinessCategory[];
  location: LocationCoordinates | null;
  radius: number;
  sortBy: 'distance' | 'rating' | 'relevance' | 'recent';
  results: BusinessWithDistance[];
  suggestions: SearchSuggestion[];
  filters: SearchFilters;
  isLoading: boolean;
  hasMore: boolean;
}

interface SearchFilters {
  priceRange?: [number, number];
  rating?: number;
  openNow?: boolean;
  hasPhotos?: boolean;
  hasReviews?: boolean;
}
```

### Frontend Component Architecture
```
apps/mobile/src/components/search/
├── SearchBar/              # Main search input with autocomplete
├── FilterPanel/           # Category and advanced filters
├── FilterChip/            # Individual filter display
├── SearchResults/         # Results list with sorting
├── SearchSuggestions/     # Autocomplete suggestions
├── EmptySearchState/      # No results handling
└── index.ts
```

### Search Suggestion Implementation
**Typeahead and Autocomplete Logic:**
```typescript
interface SearchSuggestion {
  type: 'business' | 'category' | 'query';
  text: string;
  subtitle?: string;
  count?: number;
  icon?: string;
}

// Suggestion endpoint logic
const generateSuggestions = async (query: string, location?: Coordinates) => {
  // Business name matches
  const businessMatches = await searchBusinessNames(query, location);

  // Category matches
  const categoryMatches = await searchCategories(query);

  // Popular query matches
  const queryMatches = await getPopularQueries(query, location);

  return [...businessMatches, ...categoryMatches, ...queryMatches];
};
```

### Performance Optimization Context
**Search Performance Requirements:**
- Full-text search with GIN indexes for sub-second responses
- Search result caching with location and filter-based cache keys
- Debounced autocomplete to reduce API calls (300ms delay)
- Pagination with cursor-based or offset-based approaches
- Client-side result caching for back navigation

### Filter UI/UX Patterns
**Filter Interface Design:**
```typescript
// Filter chip component for active filters
interface FilterChipProps {
  label: string;
  onRemove: () => void;
  type: 'location' | 'category' | 'text' | 'custom';
}

// Filter panel with collapsible sections
interface FilterPanelProps {
  categories: CategoryInfo[];
  activeFilters: SearchFilters;
  onFilterChange: (filters: SearchFilters) => void;
  resultCounts: Record<string, number>;
}
```

### Search Analytics Context
**Search Metrics and Insights:**
- Popular search queries by location and time
- Filter usage patterns and combinations
- Search result click-through rates
- Empty search query analysis for business opportunity identification
- Search performance metrics (response time, result quality)

### Empty State Handling
**No Results User Experience:**
```typescript
interface EmptySearchStateProps {
  query: string;
  location: LocationCoordinates;
  onSuggestionSelect: (suggestion: string) => void;
  alternativeBusinesses: Business[];
}

// Empty state suggestions
const generateAlternativeSuggestions = (query: string, location: Coordinates) => {
  return {
    broaderSearch: removeLastWord(query),
    nearbyAlternatives: findSimilarBusinesses(query, location),
    popularInArea: getPopularBusinesses(location),
    categoryExpansion: expandSearchToSimilarCategories(query)
  };
};
```

### Testing Requirements Context
[Source: architecture/testing-strategy.md]
**Search and Filter Tests:**
- `apps/api/tests/functions/business/search.test.ts`
- `apps/mobile/tests/components/SearchBar.test.tsx`
- `apps/mobile/tests/services/searchService.test.ts`

**Test Scenarios:**
- Full-text search with various query types
- Category filtering and combination logic
- Search suggestion generation and ranking
- Filter state management and persistence
- Search performance under load
- Empty state handling and alternative suggestions
- Mobile search UI interaction and accessibility

### Search Result Caching Strategy
**Cache Key Structure:**
```typescript
const generateCacheKey = (params: SearchParams) => {
  const { query, categories, location, radius, sort, filters } = params;
  const locationKey = location ? `${location.lat},${location.lng}` : 'global';
  const filtersKey = createHashFromFilters(filters);

  return `search:${query}:${categories.join(',')}:${locationKey}:${radius}:${sort}:${filtersKey}`;
};

// Cache TTL based on search type
const getCacheTTL = (searchType: string) => {
  switch (searchType) {
    case 'location_based': return 300; // 5 minutes
    case 'category_only': return 900; // 15 minutes
    case 'text_search': return 600; // 10 minutes
    default: return 300;
  }
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*