# Story 2.2: Location-Based Business Discovery

## Status
Approved

## Story
**As a** consumer,
**I want** to discover businesses near my current location or a specified area,
**so that** I can find relevant local services and products when I need them.

## Acceptance Criteria
1. GPS-based location detection requests user permission and uses current coordinates for search
2. Manual location entry allows users to search specific addresses or neighborhoods
3. Distance-based search returns businesses within specified radius (1, 5, 10, 25 miles)
4. Map view displays business locations with markers showing business type icons
5. List view shows businesses sorted by distance with basic info (name, category, distance, rating preview)
6. Location search performance returns results within 1 second for optimal user experience
7. Geolocation accuracy handles both precise GPS coordinates and approximate zip code areas
8. Search results update automatically when user changes location or moves map view

## Tasks / Subtasks
- [ ] **Task 1: Location Permission and GPS Integration** (AC: 1, 7)
  - [ ] Implement location permission request using react-native-permissions
  - [ ] Create geolocation service in apps/mobile/src/services/locationService.ts
  - [ ] Add GPS coordinate acquisition with error handling
  - [ ] Implement location permission flow with fallback options
  - [ ] Create location accuracy indicators and confidence levels
  - [ ] Add background location updates for improved user experience
  - [ ] Implement location caching to reduce battery usage

- [ ] **Task 2: Manual Location Entry System** (AC: 2, 7)
  - [ ] Create LocationInput component with autocomplete
  - [ ] Integrate Google Places API for address suggestions
  - [ ] Implement geocoding for address-to-coordinates conversion
  - [ ] Add location history and saved locations functionality
  - [ ] Create location validation and error handling
  - [ ] Implement zip code area expansion for broader searches
  - [ ] Add recent searches and location bookmarks

- [ ] **Task 3: Distance-Based Search Backend** (AC: 3, 6)
  - [ ] Enhance GET /businesses endpoint with location parameters
  - [ ] Implement PostGIS spatial queries for radius-based search
  - [ ] Add distance calculation and sorting in database queries
  - [ ] Create search result caching using Redis for performance
  - [ ] Implement search result pagination for large datasets
  - [ ] Add geographic indexing optimization for sub-second responses
  - [ ] Create location-based search analytics and monitoring

- [ ] **Task 4: Map View Implementation** (AC: 4, 8)
  - [ ] Create MapView component using react-native-maps
  - [ ] Implement business location markers with custom icons
  - [ ] Add marker clustering for dense business areas
  - [ ] Create marker tap interaction to show business summary
  - [ ] Implement map region change detection for search updates
  - [ ] Add user location indicator and centering functionality
  - [ ] Create map loading states and error handling

- [ ] **Task 5: Business List View** (AC: 5)
  - [ ] Create BusinessListView component with FlatList optimization
  - [ ] Implement BusinessListItem with distance, rating, basic info
  - [ ] Add list item tap navigation to business profile
  - [ ] Create list loading states with skeleton placeholders
  - [ ] Implement pull-to-refresh and infinite scroll
  - [ ] Add list sorting options (distance, rating, name)
  - [ ] Create empty state handling for no results

- [ ] **Task 6: Search Performance Optimization** (AC: 6)
  - [ ] Implement debounced search to reduce API calls
  - [ ] Add result caching with location-based cache keys
  - [ ] Create search result preloading for common areas
  - [ ] Implement progressive loading (nearby first, then expanding radius)
  - [ ] Add search performance monitoring and metrics
  - [ ] Create fallback strategies for slow network conditions
  - [ ] Implement offline cached results for previously searched areas

- [ ] **Task 7: Location Accuracy and Fallback Handling** (AC: 7)
  - [ ] Implement GPS accuracy assessment and confidence scoring
  - [ ] Create IP-based location fallback for GPS unavailable scenarios
  - [ ] Add manual location refinement for inaccurate GPS
  - [ ] Implement location service unavailable handling
  - [ ] Create location permission denied user flow
  - [ ] Add location accuracy indicators in UI
  - [ ] Implement location update frequency management

- [ ] **Task 8: Dynamic Search Updates** (AC: 8)
  - [ ] Implement real-time search result updates on location change
  - [ ] Create map region change detection with search triggers
  - [ ] Add automatic location updates with user movement
  - [ ] Implement search result invalidation on location changes
  - [ ] Create search update notifications and user feedback
  - [ ] Add bandwidth-conscious update strategies
  - [ ] Implement search history and context preservation

## Dev Notes

### Previous Story Insights
Stories 1.3 (Database Schema) and 1.4 (Business Creation) established the business data structure and API foundation. This story focuses on location-based querying and discovery user experience.

### Database Spatial Query Context
[Source: architecture/database-schema.md + backend-architecture.md]
**PostGIS Spatial Queries for Location Search:**
```sql
SELECT *,
       ST_Distance(
         ST_Point((location->>'longitude')::float, (location->>'latitude')::float)::geography,
         ST_Point($1, $2)::geography
       ) / 1000 as distance_km
FROM businesses
WHERE is_active = TRUE
  AND ST_DWithin(
    ST_Point((location->>'longitude')::float, (location->>'latitude')::float)::geography,
    ST_Point($1, $2)::geography,
    $3 * 1000
  )
ORDER BY distance_km
LIMIT $4 OFFSET $5;
```

### API Enhancement Context
[Source: architecture/api-specification.md]
**Enhanced Business Search Endpoint:**
- `GET /businesses?latitude={lat}&longitude={lng}&radius={miles}&limit={n}&offset={n}`
- Response includes distance calculation for each business
- Pagination support for large result sets
- Caching headers for performance optimization

### Location Services Architecture
**React Native Location Implementation:**
```typescript
// Location service structure
interface LocationService {
  getCurrentLocation(): Promise<LocationCoordinates>;
  requestLocationPermission(): Promise<boolean>;
  watchLocation(callback: (location: LocationCoordinates) => void): void;
  geocodeAddress(address: string): Promise<LocationCoordinates>;
  reverseGeocode(coordinates: LocationCoordinates): Promise<string>;
}
```

### Map Integration Context
[Source: architecture/tech-stack.md]
**Maps and Location Technologies:**
- **Maps**: react-native-maps for native map components
- **Location**: react-native-geolocation-service for GPS
- **Permissions**: react-native-permissions for location access
- **Geocoding**: Google Maps Geocoding API for address conversion
- **Places**: Google Places API for address autocomplete

### Performance Requirements Context
[Source: Story AC: 6]
**Sub-Second Search Performance:**
- Database spatial indexing with PostGIS
- Redis caching for common search areas
- Result pagination to limit data transfer
- Progressive loading strategies
- Client-side result caching

### Frontend Component Architecture
```
apps/mobile/src/components/discovery/
├── LocationInput/           # Address search and autocomplete
├── MapView/                # Business location map display
├── BusinessListView/       # List of nearby businesses
├── BusinessListItem/       # Individual business in list
├── LocationPermission/     # Permission request flow
└── index.ts
```

### Business Repository Enhancement Context
[Source: architecture/backend-architecture.md#data-access-layer]
**Enhanced Business Repository Methods:**
```typescript
interface BusinessRepository {
  searchByLocation(
    latitude: number,
    longitude: number,
    radius: number,
    filters: SearchFilters
  ): Promise<BusinessWithDistance[]>;

  searchByBounds(
    northEast: Coordinates,
    southWest: Coordinates,
    filters: SearchFilters
  ): Promise<Business[]>;
}

interface BusinessWithDistance extends Business {
  distance?: number; // in kilometers
}
```

### State Management Context
**Location and Discovery State:**
```typescript
interface DiscoveryState {
  userLocation: LocationCoordinates | null;
  searchRadius: number;
  businesses: BusinessWithDistance[];
  isLoading: boolean;
  mapRegion: MapRegion;
  searchFilters: SearchFilters;
  locationPermission: 'granted' | 'denied' | 'pending';
}
```

### Location Permission Flow
**iOS and Android Permission Handling:**
```typescript
const requestLocationPermission = async (): Promise<boolean> => {
  try {
    const result = await request(PERMISSIONS.IOS.LOCATION_WHEN_IN_USE);
    return result === RESULTS.GRANTED;
  } catch (error) {
    // Handle permission request error
    return false;
  }
};
```

### Search Performance Optimization
**Caching Strategy:**
- Redis cache key: `businesses:location:{lat}:{lng}:{radius}:{filters_hash}`
- Cache TTL: 5 minutes for location-based searches
- Cache warming for popular locations
- Client-side result caching with location-based invalidation

### Map Marker Clustering
**Business Density Handling:**
- Marker clustering for dense business areas (>10 businesses in view)
- Custom cluster icons showing business count
- Cluster tap to zoom functionality
- Individual marker display at appropriate zoom levels

### Testing Requirements Context
[Source: architecture/testing-strategy.md]
**Location-Based Tests:**
- `apps/mobile/tests/services/locationService.test.ts`
- `apps/mobile/tests/components/MapView.test.tsx`
- `apps/api/tests/repositories/businessRepository.test.ts` (spatial queries)

**Test Scenarios:**
- GPS permission request and handling
- Location-based business search with various radii
- Map marker display and clustering
- Search performance under load
- Location accuracy and fallback scenarios
- Manual location entry and geocoding

### Error Handling Requirements
**Location Service Error Scenarios:**
- GPS unavailable or disabled
- Location permission denied
- Network unavailable for geocoding
- Inaccurate location data
- Search timeout or server errors
- Empty search results

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*