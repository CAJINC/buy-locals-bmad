# Story 4.1: Review & Rating System

## Status
Approved

## Story
**As a** consumer,
**I want** to leave reviews and ratings for businesses I've used,
**so that** I can share my experiences and help other community members make informed decisions.

## Acceptance Criteria
1. Five-star rating system with half-star precision for granular feedback
2. Written review functionality with character limits and basic formatting options
3. Verified purchase indicators distinguish reviews from confirmed customers
4. Photo uploads allow consumers to share visual evidence of their experience
5. Review submission requires authentication and prevents duplicate reviews per business/user
6. Review display shows date, rating, written content, and reviewer's first name/initial
7. Helpful vote system allows community to identify most useful reviews
8. Review editing capability within 24 hours of submission with edit history tracking

## Tasks / Subtasks
- [ ] **Task 1: Review Backend API Infrastructure** (AC: 1, 2, 5, 8)
  - [ ] Create review endpoints in apps/api/src/functions/review/
  - [ ] Implement POST /reviews for review creation with validation
  - [ ] Add GET /businesses/{id}/reviews with pagination and filtering
  - [ ] Create PUT /reviews/{id} for review editing with history tracking
  - [ ] Implement review service layer in apps/api/src/services/reviewService.ts
  - [ ] Add review repository with duplicate prevention logic
  - [ ] Create review validation schemas with content and rating rules

- [ ] **Task 2: Rating System Implementation** (AC: 1)
  - [ ] Create StarRating component with half-star precision
  - [ ] Implement rating input with visual feedback and validation
  - [ ] Add rating aggregation and average calculation
  - [ ] Create rating display components for various contexts
  - [ ] Implement rating distribution visualization
  - [ ] Add rating sorting and filtering options
  - [ ] Create rating analytics for business insights

- [ ] **Task 3: Review Content Management** (AC: 2, 6)
  - [ ] Create ReviewForm component with rich text input
  - [ ] Implement character limits and validation feedback
  - [ ] Add basic text formatting options (bold, italic, lists)
  - [ ] Create review display component with proper formatting
  - [ ] Implement review content sanitization and security
  - [ ] Add review preview before submission
  - [ ] Create review templates for common feedback types

- [ ] **Task 4: Verified Purchase System** (AC: 3)
  - [ ] Implement purchase verification logic in review service
  - [ ] Add verified badge display in review components
  - [ ] Create verification status in review data model
  - [ ] Implement transaction-review linking system
  - [ ] Add verified review filtering and sorting
  - [ ] Create verification analytics for trust metrics
  - [ ] Implement verification appeal process

- [ ] **Task 5: Photo Upload Functionality** (AC: 4)
  - [ ] Create ReviewPhotoUpload component with drag-and-drop
  - [ ] Implement photo validation and compression
  - [ ] Add photo gallery display in reviews
  - [ ] Create photo moderation and approval workflow
  - [ ] Implement photo storage and CDN integration
  - [ ] Add photo deletion and management capabilities
  - [ ] Create photo analytics and usage tracking

- [ ] **Task 6: Review Display and User Context** (AC: 6)
  - [ ] Create ReviewCard component with user information
  - [ ] Implement reviewer anonymity options (first name + initial)
  - [ ] Add review date formatting and time-since display
  - [ ] Create reviewer profile badges and reputation indicators
  - [ ] Implement review threading and conversation support
  - [ ] Add review social proof elements
  - [ ] Create review accessibility features

- [ ] **Task 7: Helpful Vote System** (AC: 7)
  - [ ] Implement helpful vote backend with user tracking
  - [ ] Create VoteButtons component for review usefulness
  - [ ] Add vote count display and sorting by helpfulness
  - [ ] Implement vote validation and spam prevention
  - [ ] Create vote analytics for review quality assessment
  - [ ] Add user vote history and preferences
  - [ ] Implement vote-based review ranking algorithm

- [ ] **Task 8: Review Editing and History** (AC: 8)
  - [ ] Implement 24-hour edit window with countdown timer
  - [ ] Create edit history tracking and version control
  - [ ] Add ReviewEditForm with change highlighting
  - [ ] Implement edit notifications to business owners
  - [ ] Create edit history display for transparency
  - [ ] Add edit reason collection and categorization
  - [ ] Implement edit analytics and patterns tracking

## Dev Notes

### Previous Story Insights
Epic 3 established transaction processing. This story builds the community trust layer by enabling verified customers to share authentic feedback about their experiences.

### Review Data Model Context
[Source: architecture/data-models.md#review]
**Complete Review Interface:**
```typescript
interface Review {
  id: string;
  authorId: string;
  businessId: string;
  bookingId?: string;
  rating: number; // 1.0 to 5.0 with 0.5 increments
  content: string;
  photos?: string[];
  isVerifiedPurchase: boolean;
  helpfulVotes: number;
  businessResponse?: {
    content: string;
    respondedAt: Date;
    responderId: string;
  };
  status: 'published' | 'flagged' | 'removed';
  editHistory: ReviewEdit[];
  createdAt: Date;
  updatedAt: Date;
}

interface ReviewEdit {
  id: string;
  editedAt: Date;
  previousContent: string;
  previousRating: number;
  reason?: string;
}
```

### Review Service Architecture
[Source: architecture/components.md#review-service]
**Review Service Responsibilities:**
- Review and rating management, content moderation, business response handling
- Key Interfaces: POST /reviews, GET /reviews, PUT /reviews/{id}/helpful
- Dependencies: PostgreSQL for review data, Redis for caching, Amazon Comprehend for sentiment analysis

### Rating System Implementation
**Star Rating Component:**
```typescript
interface StarRatingProps {
  rating: number;
  maxRating: number;
  allowHalfStars: boolean;
  interactive: boolean;
  onRatingChange?: (rating: number) => void;
  size: 'small' | 'medium' | 'large';
}

export const StarRating: React.FC<StarRatingProps> = ({
  rating,
  maxRating = 5,
  allowHalfStars = true,
  interactive = false,
  onRatingChange,
  size = 'medium'
}) => {
  const [hoverRating, setHoverRating] = useState(0);

  const handleStarClick = (starValue: number) => {
    if (interactive && onRatingChange) {
      const newRating = allowHalfStars ? starValue : Math.ceil(starValue);
      onRatingChange(newRating);
    }
  };

  return (
    <StarContainer>
      {Array.from({ length: maxRating }, (_, index) => {
        const starValue = index + 1;
        const fillPercentage = Math.min(Math.max(rating - index, 0), 1);

        return (
          <Star
            key={index}
            fillPercentage={fillPercentage}
            onPress={() => handleStarClick(starValue)}
            onHoverIn={() => interactive && setHoverRating(starValue)}
            onHoverOut={() => interactive && setHoverRating(0)}
            size={size}
          />
        );
      })}
    </StarContainer>
  );
};
```

### Verified Purchase System
**Purchase Verification Logic:**
```typescript
interface VerificationService {
  verifyPurchase(userId: string, businessId: string): Promise<VerificationResult>;
  linkReviewToTransaction(reviewId: string, transactionId: string): Promise<void>;
  getVerificationBadge(review: Review): VerificationBadge;
}

const verifyPurchase = async (userId: string, businessId: string): Promise<VerificationResult> => {
  const transactions = await db('transactions')
    .join('bookings', 'transactions.booking_id', 'bookings.id')
    .where('bookings.consumer_id', userId)
    .where('bookings.business_id', businessId)
    .where('transactions.status', 'completed')
    .where('bookings.status', 'completed');

  if (transactions.length === 0) {
    return { verified: false, reason: 'No completed transactions found' };
  }

  const mostRecentTransaction = transactions[0];
  return {
    verified: true,
    transactionId: mostRecentTransaction.id,
    serviceDate: mostRecentTransaction.scheduled_at,
    verificationDate: new Date()
  };
};
```

### Photo Upload and Management
**Review Photo System:**
```typescript
interface ReviewPhotoService {
  uploadReviewPhotos(reviewId: string, photos: File[]): Promise<string[]>;
  validatePhotoContent(photo: File): Promise<boolean>;
  compressPhoto(photo: File): Promise<File>;
  moderatePhoto(photoUrl: string): Promise<ModerationResult>;
}

// Photo upload component
export const ReviewPhotoUpload: React.FC<ReviewPhotoUploadProps> = ({
  onPhotosChange,
  maxPhotos = 5,
  maxSizePerPhoto = 5 * 1024 * 1024 // 5MB
}) => {
  const [photos, setPhotos] = useState<File[]>([]);
  const [uploading, setUploading] = useState(false);

  const handlePhotoAdd = async (newPhotos: File[]) => {
    setUploading(true);

    try {
      const validPhotos = await Promise.all(
        newPhotos.map(async (photo) => {
          if (photo.size > maxSizePerPhoto) {
            throw new Error(`Photo ${photo.name} exceeds size limit`);
          }

          return await compressPhoto(photo);
        })
      );

      const updatedPhotos = [...photos, ...validPhotos].slice(0, maxPhotos);
      setPhotos(updatedPhotos);
      onPhotosChange(updatedPhotos);
    } catch (error) {
      console.error('Photo upload error:', error);
    } finally {
      setUploading(false);
    }
  };

  return (
    <PhotoUploadContainer>
      <PhotoDropZone onDrop={handlePhotoAdd} />
      <PhotoPreviewGrid photos={photos} onRemove={handlePhotoRemove} />
      {uploading && <LoadingIndicator />}
    </PhotoUploadContainer>
  );
};
```

### Helpful Vote System
**Community Feedback on Reviews:**
```typescript
interface HelpfulVoteService {
  voteHelpful(reviewId: string, userId: string, isHelpful: boolean): Promise<void>;
  getVoteStatus(reviewId: string, userId: string): Promise<VoteStatus>;
  calculateHelpfulnessScore(reviewId: string): Promise<number>;
}

// Vote tracking to prevent duplicate votes
const voteHelpful = async (reviewId: string, userId: string, isHelpful: boolean) => {
  await db.transaction(async (trx) => {
    // Remove any existing vote by this user for this review
    await trx('review_votes')
      .where('review_id', reviewId)
      .where('user_id', userId)
      .delete();

    // Add new vote
    await trx('review_votes').insert({
      review_id: reviewId,
      user_id: userId,
      is_helpful: isHelpful,
      created_at: new Date()
    });

    // Update helpful vote count on review
    const voteCount = await trx('review_votes')
      .where('review_id', reviewId)
      .where('is_helpful', true)
      .count('* as count')
      .first();

    await trx('reviews')
      .where('id', reviewId)
      .update({ helpful_votes: voteCount.count });
  });
};
```

### Review Editing System
**Time-Limited Editing with History:**
```typescript
interface ReviewEditService {
  canEditReview(reviewId: string, userId: string): Promise<boolean>;
  editReview(reviewId: string, updates: ReviewUpdate, reason?: string): Promise<Review>;
  getEditHistory(reviewId: string): Promise<ReviewEdit[]>;
}

const canEditReview = async (reviewId: string, userId: string): Promise<boolean> => {
  const review = await getReviewById(reviewId);

  if (review.authorId !== userId) {
    return false;
  }

  const hoursSinceCreation = (Date.now() - review.createdAt.getTime()) / (1000 * 60 * 60);
  return hoursSinceCreation <= 24;
};

const editReview = async (reviewId: string, updates: ReviewUpdate, reason?: string) => {
  return await db.transaction(async (trx) => {
    const originalReview = await trx('reviews').where('id', reviewId).first();

    // Save edit history
    await trx('review_edits').insert({
      review_id: reviewId,
      previous_content: originalReview.content,
      previous_rating: originalReview.rating,
      edited_at: new Date(),
      reason
    });

    // Update review
    const updatedReview = await trx('reviews')
      .where('id', reviewId)
      .update({
        content: updates.content,
        rating: updates.rating,
        updated_at: new Date()
      })
      .returning('*')
      .first();

    return updatedReview;
  });
};
```

### Database Schema Extensions
**Review System Tables:**
```sql
-- Reviews table (base from existing schema)
ALTER TABLE reviews ADD COLUMN edit_count INTEGER DEFAULT 0;
ALTER TABLE reviews ADD COLUMN last_edited_at TIMESTAMP WITH TIME ZONE;

-- Review edits history
CREATE TABLE review_edits (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    review_id UUID NOT NULL REFERENCES reviews(id) ON DELETE CASCADE,
    previous_content TEXT NOT NULL,
    previous_rating DECIMAL(2,1) NOT NULL,
    reason TEXT,
    edited_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Review helpful votes
CREATE TABLE review_votes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    review_id UUID NOT NULL REFERENCES reviews(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    is_helpful BOOLEAN NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(review_id, user_id)
);

-- Review photos
CREATE TABLE review_photos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    review_id UUID NOT NULL REFERENCES reviews(id) ON DELETE CASCADE,
    photo_url TEXT NOT NULL,
    caption TEXT,
    display_order INTEGER DEFAULT 0,
    moderation_status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### Frontend Component Architecture
```
apps/mobile/src/components/reviews/
├── ReviewForm/             # Review creation and editing
├── StarRating/            # Rating input and display
├── ReviewCard/            # Individual review display
├── ReviewList/            # List of reviews with filtering
├── ReviewPhotoUpload/     # Photo upload for reviews
├── HelpfulVotes/         # Vote buttons and counts
├── VerifiedBadge/        # Purchase verification indicator
└── index.ts
```

### Testing Requirements Context
**Review System Tests:**
- `apps/api/tests/functions/review/create.test.ts`
- `apps/mobile/tests/components/ReviewForm.test.tsx`
- `apps/api/tests/services/reviewService.test.ts`

**Test Scenarios:**
- Review creation with rating and content validation
- Purchase verification and verified badge display
- Photo upload, compression, and display
- Helpful vote system and duplicate prevention
- Review editing within 24-hour window
- Review history tracking and display
- Star rating input and half-star precision
- Review display with proper user information

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*