# Story 2.4: Business Hours & Availability Display

## Status
Approved

## Story
**As a** consumer,
**I want** to see current business hours and availability status,
**so that** I know when businesses are open and can plan my visits accordingly.

## Acceptance Criteria
1. Current open/closed status prominently displayed on business profiles
2. Full weekly hours schedule shows standard operating hours for each day
3. Special hours handling for holidays, temporary closures, and modified schedules
4. "Opens at" or "Closes at" messaging shows next status change with countdown timer
5. Business owners can set temporary hour changes that override standard schedules
6. Time zone handling ensures accurate hours display for user's location
7. Mobile app shows hours in user's local time regardless of business location
8. Hours information is clearly visible in search results and business cards

## Tasks / Subtasks
- [ ] **Task 1: Business Hours Data Enhancement** (AC: 2, 3, 5)
  - [ ] Enhance business hours data model to support special hours
  - [ ] Create SpecialHours entity for holiday and temporary schedule overrides
  - [ ] Implement business hours validation in backend APIs
  - [ ] Add business hours update endpoints for owners
  - [ ] Create default hours templates for common business types
  - [ ] Implement hours history tracking for analytics
  - [ ] Add bulk hours update functionality for chains

- [ ] **Task 2: Time Zone and Status Calculation** (AC: 1, 4, 6, 7)
  - [ ] Implement business timezone detection from location
  - [ ] Create hours calculation service with timezone conversion
  - [ ] Add real-time open/closed status determination
  - [ ] Implement next status change calculation and countdown
  - [ ] Create user timezone detection and preference handling
  - [ ] Add daylight saving time handling and transitions
  - [ ] Implement holiday recognition and special hours application

- [ ] **Task 3: Hours Display Components** (AC: 1, 2, 8)
  - [ ] Create BusinessHours component with current status indicator
  - [ ] Implement WeeklySchedule component with expandable details
  - [ ] Add OpenStatus badge for prominent display
  - [ ] Create HoursPreview component for search results
  - [ ] Implement CountdownTimer for next status change
  - [ ] Add timezone indicator and conversion display
  - [ ] Create responsive hours display for mobile/desktop

- [ ] **Task 4: Special Hours Management** (AC: 3, 5)
  - [ ] Create SpecialHours management interface for business owners
  - [ ] Implement holiday hours preset templates
  - [ ] Add temporary closure scheduling functionality
  - [ ] Create special hours override logic in status calculation
  - [ ] Implement special hours expiration and cleanup
  - [ ] Add special hours notification system for customers
  - [ ] Create special hours analytics and reporting

- [ ] **Task 5: Business Owner Hours Management** (AC: 5)
  - [ ] Create BusinessHoursEditor component for owners
  - [ ] Implement drag-and-drop hours editing interface
  - [ ] Add bulk hours update for multiple days
  - [ ] Create hours template saving and application
  - [ ] Implement hours change confirmation and validation
  - [ ] Add hours change notification to regular customers
  - [ ] Create hours management mobile interface

- [ ] **Task 6: Real-Time Status Updates** (AC: 1, 4)
  - [ ] Implement real-time status polling and updates
  - [ ] Create WebSocket or push notification system for status changes
  - [ ] Add automatic status refresh at business state transitions
  - [ ] Implement offline status calculation and sync
  - [ ] Create status change animations and visual feedback
  - [ ] Add user notification preferences for status changes
  - [ ] Implement status accuracy verification and correction

- [ ] **Task 7: Search Results Integration** (AC: 8)
  - [ ] Integrate hours display into business search results
  - [ ] Add "Open Now" filter option to search functionality
  - [ ] Create hours-based search result sorting
  - [ ] Implement compact hours display for list items
  - [ ] Add opening hours in search result snippets
  - [ ] Create hours-based business recommendation logic
  - [ ] Implement hours information in map markers

- [ ] **Task 8: Performance and Caching** (AC: 1, 4)
  - [ ] Implement hours calculation caching with TTL
  - [ ] Create efficient timezone conversion caching
  - [ ] Add status change prediction and precomputation
  - [ ] Implement hours data compression for mobile
  - [ ] Create hours calculation performance monitoring
  - [ ] Add edge caching for frequently accessed hours data
  - [ ] Implement client-side hours caching and invalidation

## Dev Notes

### Previous Story Insights
Story 2.1 (Enhanced Business Profiles) established the foundation for displaying business information. This story focuses specifically on the complex time-based calculations and display requirements for business hours.

### Enhanced Business Hours Data Model
[Source: architecture/data-models.md#business]
**Extended Business Hours Structure:**
```typescript
interface BusinessHours {
  standard: {
    [key: string]: {
      open: string;      // "09:00"
      close: string;     // "17:00"
      isClosed: boolean;
    };
  };
  special: SpecialHours[];
  timezone: string;        // "America/New_York"
  lastUpdated: Date;
}

interface SpecialHours {
  id: string;
  date: string | DateRange;  // "2024-12-25" or date range
  hours: {
    open?: string;
    close?: string;
    isClosed: boolean;
    reason?: string;         // "Holiday", "Maintenance", etc.
  };
  isRecurring: boolean;      // For annual holidays
  expiresAt?: Date;          // For temporary changes
}
```

### Database Schema Enhancement
[Source: architecture/database-schema.md]
**Special Hours Table:**
```sql
CREATE TABLE special_hours (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE,
    date_start DATE NOT NULL,
    date_end DATE,
    open_time TIME,
    close_time TIME,
    is_closed BOOLEAN DEFAULT FALSE,
    reason VARCHAR(255),
    is_recurring BOOLEAN DEFAULT FALSE,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_special_hours_business_date ON special_hours(business_id, date_start, date_end);
```

### Time Zone and Status Calculation Service
**Hours Calculation Logic:**
```typescript
interface HoursService {
  getCurrentStatus(business: Business, userTimezone?: string): BusinessStatus;
  getNextStatusChange(business: Business, userTimezone?: string): StatusChange;
  convertToUserTimezone(hours: BusinessHours, userTimezone: string): BusinessHours;
  isOpenAt(business: Business, datetime: Date): boolean;
  getEffectiveHours(business: Business, date: Date): DayHours | null;
}

interface BusinessStatus {
  isOpen: boolean;
  currentTime: Date;
  businessTime: Date;
  nextChange: StatusChange;
  specialHours?: SpecialHours;
}

interface StatusChange {
  type: 'opens' | 'closes';
  time: Date;
  countdown: number; // milliseconds until change
  formattedTime: string;
}
```

### Frontend Component Architecture
```
apps/mobile/src/components/hours/
├── BusinessHours/          # Main hours display component
├── OpenStatus/            # Open/closed status badge
├── WeeklySchedule/        # Full week hours display
├── CountdownTimer/        # Next status change timer
├── HoursPreview/          # Compact hours for search results
├── SpecialHoursNotice/    # Holiday/special hours alert
└── index.ts
```

### Open Status Component Implementation
```typescript
interface OpenStatusProps {
  business: Business;
  userTimezone?: string;
  showCountdown?: boolean;
  compact?: boolean;
}

export const OpenStatus: React.FC<OpenStatusProps> = ({
  business,
  userTimezone,
  showCountdown,
  compact
}) => {
  const status = useBusinessStatus(business, userTimezone);

  return (
    <Box flexDirection="row" alignItems="center">
      <StatusBadge
        isOpen={status.isOpen}
        variant={compact ? 'small' : 'default'}
      />
      {showCountdown && status.nextChange && (
        <CountdownTimer
          targetTime={status.nextChange.time}
          type={status.nextChange.type}
        />
      )}
    </Box>
  );
};
```

### Time Zone Handling Context
**Cross-Timezone Considerations:**
- Business timezone detection from location coordinates
- User timezone detection from device settings
- Daylight saving time transitions and handling
- International timezone support for travelers
- Timezone abbreviation display (EST, PST, etc.)

### Holiday and Special Hours Logic
**Holiday Recognition System:**
```typescript
interface HolidayService {
  getHolidays(year: number, country: string): Holiday[];
  isHoliday(date: Date, location: Location): Holiday | null;
  getSpecialHours(business: Business, date: Date): SpecialHours | null;
  applySpecialHours(standardHours: BusinessHours, date: Date): EffectiveHours;
}

// Common holidays with business hour impact
const MAJOR_HOLIDAYS = [
  'Christmas Day', 'New Year\'s Day', 'Thanksgiving',
  'Independence Day', 'Labor Day', 'Memorial Day'
];
```

### Performance Optimization Context
**Hours Calculation Caching:**
```typescript
// Cache key structure for hours status
const generateHoursCacheKey = (businessId: string, date: Date, timezone?: string) => {
  const dateKey = date.toISOString().split('T')[0];
  const tzKey = timezone || 'UTC';
  return `hours:${businessId}:${dateKey}:${tzKey}`;
};

// Cache TTL based on current time relative to next status change
const getHoursCacheTTL = (nextChange: StatusChange) => {
  const timeUntilChange = nextChange.time.getTime() - Date.now();

  if (timeUntilChange < 60000) return 30; // 30 seconds if changing soon
  if (timeUntilChange < 3600000) return 300; // 5 minutes if changing within hour
  return 1800; // 30 minutes for stable periods
};
```

### Search Integration Context
**Hours-Based Search Features:**
- "Open Now" filter using real-time status calculation
- Hours display in search result cards
- Opening hours consideration in result ranking
- Hours-based business recommendations

### Business Owner Hours Management
**Hours Management Interface:**
```typescript
interface HoursEditor {
  standardHours: WeeklyHours;
  specialHours: SpecialHours[];
  onStandardHoursChange: (hours: WeeklyHours) => void;
  onSpecialHoursAdd: (special: SpecialHours) => void;
  onSpecialHoursRemove: (id: string) => void;
}

// Hours validation rules
const validateBusinessHours = (hours: BusinessHours): ValidationResult => {
  // Validate time format, logical ordering, timezone compatibility
  // Check for overlapping special hours, reasonable operating hours
  // Validate timezone against business location
};
```

### Real-Time Updates Context
**Status Change Notifications:**
- WebSocket connections for real-time status updates
- Push notifications for favorite businesses status changes
- Automatic UI refresh at calculated status change times
- Background status calculation and sync

### Testing Requirements Context
[Source: architecture/testing-strategy.md]
**Hours and Timezone Tests:**
- `apps/api/tests/services/hoursService.test.ts`
- `apps/mobile/tests/components/BusinessHours.test.tsx`
- `apps/mobile/tests/utils/timezone.test.ts`

**Test Scenarios:**
- Hours calculation across different timezones
- Special hours override logic and expiration
- Status change countdown accuracy
- Holiday recognition and special hours application
- Performance of hours calculation under load
- Real-time status update synchronization
- Hours display in various UI contexts

### Accessibility and UX Context
**Hours Display Requirements:**
- Clear visual indicators for open/closed status
- Screen reader support for hours information
- Color-blind friendly status indicators
- Intuitive countdown timers and status messaging
- Mobile-optimized hours display and interaction

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*