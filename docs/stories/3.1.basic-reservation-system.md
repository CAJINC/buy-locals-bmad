# Story 3.1: Basic Reservation System

## Status
Approved

## Story
**As a** consumer,
**I want** to book appointments or reserve services with local businesses,
**so that** I can secure specific time slots and avoid scheduling conflicts.

## Acceptance Criteria
1. Calendar interface shows available appointment slots for service-based businesses
2. Time slot selection allows consumers to choose from business-defined availability windows
3. Booking form collects necessary information (name, contact, service type, special requests)
4. Instant booking confirmation sent via email and push notification to both parties
5. Business owners can define their available hours, service duration, and buffer time between appointments
6. Double-booking prevention ensures time slots become unavailable once reserved
7. Basic cancellation functionality allows consumers to cancel with appropriate notice period
8. Booking calendar integrates with business owner's existing calendar systems (Google Calendar, Outlook)

## Tasks / Subtasks
- [ ] **Task 1: Booking Backend API Infrastructure** (AC: 2, 6)
  - [ ] Create booking endpoints in apps/api/src/functions/booking/
  - [ ] Implement POST /bookings for new booking creation
  - [ ] Create GET /businesses/{id}/availability endpoint for time slots
  - [ ] Add booking service layer in apps/api/src/services/bookingService.ts
  - [ ] Implement booking repository with atomic transactions
  - [ ] Create booking validation schemas with time conflict detection
  - [ ] Add double-booking prevention with database locks

- [ ] **Task 2: Availability Management System** (AC: 1, 5)
  - [ ] Create business availability configuration in business settings
  - [ ] Implement time slot generation algorithm based on service duration
  - [ ] Add buffer time handling between consecutive bookings
  - [ ] Create availability calculation with existing bookings exclusion
  - [ ] Implement recurring availability patterns (weekly schedules)
  - [ ] Add holiday and blackout date management
  - [ ] Create availability caching for performance optimization

- [ ] **Task 3: Calendar Interface Components** (AC: 1, 2)
  - [ ] Create BookingCalendar component with date/time selection
  - [ ] Implement AvailabilityGrid showing available time slots
  - [ ] Add TimeSlot component with booking interaction
  - [ ] Create month/week/day view navigation
  - [ ] Implement calendar loading states and error handling
  - [ ] Add accessibility support for screen readers
  - [ ] Create responsive calendar design for mobile/desktop

- [ ] **Task 4: Booking Form Implementation** (AC: 3, 4)
  - [ ] Create BookingForm component with validation
  - [ ] Implement customer information collection (name, phone, email)
  - [ ] Add service selection dropdown with details and pricing
  - [ ] Create special requests text area with character limits
  - [ ] Implement form validation with real-time feedback
  - [ ] Add booking confirmation flow with summary review
  - [ ] Create booking submission with loading and success states

- [ ] **Task 5: Notification System** (AC: 4)
  - [ ] Implement booking confirmation email templates
  - [ ] Create push notification system for mobile apps
  - [ ] Add notification service in apps/api/src/services/notificationService.ts
  - [ ] Implement email delivery using AWS SES
  - [ ] Create notification templates for different booking events
  - [ ] Add notification preference management
  - [ ] Implement notification delivery tracking and retry logic

- [ ] **Task 6: Cancellation Management** (AC: 7)
  - [ ] Create booking cancellation endpoints (PUT /bookings/{id}/cancel)
  - [ ] Implement cancellation policy enforcement (notice period validation)
  - [ ] Add cancellation reason collection and categorization
  - [ ] Create cancellation confirmation flow for consumers
  - [ ] Implement automatic availability slot release on cancellation
  - [ ] Add cancellation notification to business owners
  - [ ] Create cancellation analytics and reporting

- [ ] **Task 7: Calendar Integration** (AC: 8)
  - [ ] Implement Google Calendar API integration
  - [ ] Add Outlook/Exchange calendar synchronization
  - [ ] Create calendar event creation for confirmed bookings
  - [ ] Implement two-way sync for availability management
  - [ ] Add calendar authentication and authorization flow
  - [ ] Create calendar conflict detection and resolution
  - [ ] Implement calendar sync error handling and retry logic

- [ ] **Task 8: Business Dashboard Integration** (AC: 5, 6)
  - [ ] Create business booking management interface
  - [ ] Implement BookingDashboard component for business owners
  - [ ] Add upcoming bookings display with customer information
  - [ ] Create booking status management (confirm, reschedule, cancel)
  - [ ] Implement availability settings configuration
  - [ ] Add booking analytics and insights
  - [ ] Create booking export functionality for business records

## Dev Notes

### Previous Story Insights
Epic 2 established business profiles and discovery. This story creates the booking foundation that enables actual customer-business transactions through time-based reservations.

### Booking Data Model Context
[Source: architecture/data-models.md#booking]
**Complete Booking Interface:**
```typescript
interface Booking {
  id: string;
  consumerId: string;
  businessId: string;
  serviceId: string;
  scheduledAt: Date;
  duration: number; // in minutes
  status: 'pending' | 'confirmed' | 'completed' | 'cancelled' | 'no_show';
  notes?: string;
  totalAmount: number;
  customerInfo: {
    name: string;
    phone: string;
    email: string;
  };
  createdAt: Date;
  updatedAt: Date;
  cancelledAt?: Date;
  cancellationReason?: string;
}
```

### Database Schema Context
[Source: architecture/database-schema.md]
**Bookings Table Structure:**
```sql
CREATE TABLE bookings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    consumer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE,
    service_id VARCHAR(255) NOT NULL,
    scheduled_at TIMESTAMP WITH TIME ZONE NOT NULL,
    duration INTEGER NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    notes TEXT,
    total_amount DECIMAL(10,2) NOT NULL,
    customer_info JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    cancelled_at TIMESTAMP WITH TIME ZONE,
    cancellation_reason TEXT
);
```

### Booking Service Architecture
[Source: architecture/components.md#booking-service]
**Booking Service Responsibilities:**
- Appointment scheduling, reservation management, availability tracking
- Key Interfaces: POST /bookings, GET /bookings, GET /businesses/{id}/availability
- Dependencies: PostgreSQL for booking data, Redis for availability caching, SNS for notifications

### Availability Algorithm Context
**Time Slot Generation Logic:**
```typescript
interface AvailabilityService {
  generateTimeSlots(
    businessId: string,
    date: Date,
    serviceDurationMinutes: number,
    bufferMinutes: number
  ): Promise<TimeSlot[]>;

  checkAvailability(
    businessId: string,
    startTime: Date,
    duration: number
  ): Promise<boolean>;

  reserveTimeSlot(
    businessId: string,
    startTime: Date,
    duration: number,
    bookingId: string
  ): Promise<void>;
}

interface TimeSlot {
  startTime: Date;
  endTime: Date;
  isAvailable: boolean;
  price?: number;
  serviceId?: string;
}
```

### Double-Booking Prevention
**Atomic Booking Creation:**
```typescript
// Database transaction for booking creation
const createBookingWithLock = async (bookingData: CreateBookingInput) => {
  return await db.transaction(async (trx) => {
    // Lock the time slot
    const conflicting = await trx('bookings')
      .where('business_id', bookingData.businessId)
      .where('scheduled_at', '<=', bookingData.scheduledAt + duration)
      .where('scheduled_at', '>=', bookingData.scheduledAt - duration)
      .where('status', '!=', 'cancelled')
      .forUpdate();

    if (conflicting.length > 0) {
      throw new Error('Time slot no longer available');
    }

    // Create the booking
    const booking = await trx('bookings').insert(bookingData).returning('*');
    return booking[0];
  });
};
```

### Calendar Integration Context
**External Calendar APIs:**
```typescript
interface CalendarIntegration {
  createEvent(booking: Booking): Promise<string>; // returns external event ID
  updateEvent(eventId: string, booking: Booking): Promise<void>;
  deleteEvent(eventId: string): Promise<void>;
  syncAvailability(businessId: string): Promise<AvailabilityUpdate[]>;
}

// Google Calendar integration
const googleCalendarService: CalendarIntegration = {
  async createEvent(booking: Booking) {
    const event = {
      summary: `${booking.customerInfo.name} - ${booking.serviceId}`,
      start: { dateTime: booking.scheduledAt.toISOString() },
      end: { dateTime: new Date(booking.scheduledAt.getTime() + booking.duration * 60000).toISOString() },
      attendees: [{ email: booking.customerInfo.email }]
    };

    const response = await calendar.events.insert({
      calendarId: 'primary',
      resource: event
    });

    return response.data.id;
  }
};
```

### Frontend Component Architecture
```
apps/mobile/src/components/booking/
├── BookingCalendar/        # Main calendar interface
├── TimeSlot/              # Individual time slot selection
├── BookingForm/           # Booking information form
├── BookingConfirmation/   # Booking success and details
├── BookingList/           # User's bookings list
├── CancellationForm/      # Booking cancellation flow
└── index.ts
```

### Notification System Context
[Source: architecture/components.md#notification-service]
**Booking Notifications:**
```typescript
interface BookingNotification {
  type: 'booking_confirmed' | 'booking_cancelled' | 'booking_reminder';
  recipient: 'consumer' | 'business' | 'both';
  channels: ('email' | 'push' | 'sms')[];
  template: string;
  data: BookingNotificationData;
}

const sendBookingConfirmation = async (booking: Booking) => {
  await notificationService.send({
    type: 'booking_confirmed',
    recipient: 'both',
    channels: ['email', 'push'],
    template: 'booking-confirmation',
    data: {
      booking,
      businessName: booking.business.name,
      consumerName: booking.customerInfo.name
    }
  });
};
```

### API Specification Context
**Booking Endpoints:**
```typescript
// Create new booking
POST /bookings
{
  businessId, serviceId, scheduledAt, duration,
  customerInfo, notes?, totalAmount
}

// Get business availability
GET /businesses/{id}/availability?date={YYYY-MM-DD}&service={serviceId}

// Cancel booking
PUT /bookings/{id}/cancel
{
  reason, notifyBusiness
}

// Get user bookings
GET /bookings?status={status}&limit={n}&offset={n}
```

### Performance and Caching Context
**Availability Caching Strategy:**
```typescript
// Cache available time slots to reduce database load
const cacheKey = `availability:${businessId}:${date}:${serviceId}`;
const cachedSlots = await redis.get(cacheKey);

if (!cachedSlots) {
  const slots = await generateAvailabilitySlots(businessId, date, serviceId);
  await redis.setex(cacheKey, 300, JSON.stringify(slots)); // 5 minute TTL
  return slots;
}

return JSON.parse(cachedSlots);
```

### Testing Requirements Context
[Source: architecture/testing-strategy.md]
**Booking System Tests:**
- `apps/api/tests/functions/booking/create.test.ts`
- `apps/mobile/tests/components/BookingCalendar.test.tsx`
- `apps/api/tests/services/bookingService.test.ts`

**Test Scenarios:**
- Booking creation with availability validation
- Double-booking prevention under concurrent load
- Calendar integration and external sync
- Notification delivery for booking events
- Cancellation flow and policy enforcement
- Availability calculation with existing bookings
- Time zone handling for booking times

### Business Rules Context
**Booking Policies:**
- Minimum advance booking time (e.g., 2 hours notice)
- Maximum advance booking window (e.g., 90 days)
- Cancellation notice period (e.g., 24 hours for full refund)
- No-show policy and automatic status updates
- Booking modification time limits
- Service-specific booking rules and requirements

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*