# Story 3.3: Payment Processing Integration

## Status
Approved

## Story
**As a** consumer,
**I want** to securely pay for services and products through the platform,
**so that** I can complete transactions conveniently while ensuring my payment information is protected.

## Acceptance Criteria
1. Stripe payment integration supports credit cards, debit cards, and digital wallets (Apple Pay, Google Pay)
2. Secure payment form with PCI DSS compliance and SSL encryption
3. Payment processing includes tax calculation based on business location and product/service type
4. Transaction confirmation with receipt generation and email delivery
5. Escrow functionality holds payments until service completion or product pickup
6. Refund processing capability for cancelled bookings or unsatisfactory services
7. Business owners receive payouts according to platform fee structure (minus processing fees and platform commission)
8. Payment failure handling with clear error messages and retry options

## Tasks / Subtasks
- [ ] **Task 1: Stripe Payment Infrastructure** (AC: 1, 2)
  - [ ] Initialize Stripe SDK integration in backend and frontend
  - [ ] Create payment intent endpoints in apps/api/src/functions/payment/
  - [ ] Implement Stripe webhook handling for payment events
  - [ ] Add payment method storage and customer management
  - [ ] Create secure payment token handling and PCI compliance
  - [ ] Implement Apple Pay and Google Pay integration
  - [ ] Add 3D Secure authentication for enhanced security

- [ ] **Task 2: Payment Form Components** (AC: 1, 2, 8)
  - [ ] Create PaymentForm component with Stripe Elements
  - [ ] Implement credit/debit card input with validation
  - [ ] Add digital wallet payment buttons (Apple Pay, Google Pay)
  - [ ] Create payment method selection interface
  - [ ] Implement payment form error handling and validation
  - [ ] Add payment processing loading states and success feedback
  - [ ] Create payment method saving for future use

- [ ] **Task 3: Tax Calculation System** (AC: 3)
  - [ ] Implement tax calculation service based on business location
  - [ ] Add tax rate lookup for different product/service categories
  - [ ] Create tax-inclusive and tax-exclusive pricing options
  - [ ] Implement multi-jurisdictional tax handling (state, local, federal)
  - [ ] Add tax exemption handling for eligible customers
  - [ ] Create tax reporting and compliance features
  - [ ] Implement tax calculation caching for performance

- [ ] **Task 4: Transaction and Receipt Management** (AC: 4)
  - [ ] Create Transaction entity with comprehensive payment details
  - [ ] Implement receipt generation with itemized breakdowns
  - [ ] Add PDF receipt generation and email delivery
  - [ ] Create transaction confirmation flow with success messaging
  - [ ] Implement transaction status tracking and updates
  - [ ] Add receipt customization for business branding
  - [ ] Create transaction export functionality for accounting

- [ ] **Task 5: Escrow Payment System** (AC: 5)
  - [ ] Implement payment escrow with hold functionality
  - [ ] Create escrow release triggers (service completion, pickup confirmation)
  - [ ] Add manual escrow release for business owners
  - [ ] Implement escrow dispute handling and resolution
  - [ ] Create escrow timeout and automatic release policies
  - [ ] Add escrow status notifications for all parties
  - [ ] Implement escrow analytics and reporting

- [ ] **Task 6: Refund Processing System** (AC: 6)
  - [ ] Create refund request workflow with approval process
  - [ ] Implement automatic refunds for qualified cancellations
  - [ ] Add partial refund capabilities for service modifications
  - [ ] Create refund reason categorization and tracking
  - [ ] Implement refund notification system
  - [ ] Add refund processing timeline and status tracking
  - [ ] Create refund analytics and business insights

- [ ] **Task 7: Payout and Commission System** (AC: 7)
  - [ ] Implement business payout calculation with platform fees
  - [ ] Create automated payout scheduling (daily, weekly, monthly)
  - [ ] Add payout method management (bank accounts, debit cards)
  - [ ] Implement payout hold policies for new businesses
  - [ ] Create payout reporting and tax documentation
  - [ ] Add commission rate management and tier systems
  - [ ] Implement payout failure handling and retry logic

- [ ] **Task 8: Payment Error Handling and Recovery** (AC: 8)
  - [ ] Create comprehensive payment error classification
  - [ ] Implement payment retry mechanisms for transient failures
  - [ ] Add payment method fallback and alternative options
  - [ ] Create user-friendly error messaging and guidance
  - [ ] Implement payment recovery workflows for failed transactions
  - [ ] Add payment fraud detection and prevention measures
  - [ ] Create payment analytics and failure monitoring

## Dev Notes

### Previous Story Insights
Stories 3.1-3.2 established booking and reservation infrastructure. This story adds the crucial payment processing layer that enables actual monetary transactions and business revenue.

### Payment Service Architecture
[Source: architecture/components.md#payment-service]
**Payment Service Responsibilities:**
- Payment processing, transaction management, escrow handling, refund processing
- Key Interfaces: POST /payments/intents, POST /payments/confirm, POST /payments/refund
- Dependencies: Stripe API, PostgreSQL for transaction records, SNS for notifications

### Transaction Data Model Enhancement
[Source: architecture/data-models.md#transaction]
**Enhanced Transaction Structure:**
```typescript
interface Transaction {
  id: string;
  payerId: string;
  businessId: string;
  bookingId: string;
  amount: number;
  platformFee: number;
  processingFee: number;
  taxAmount: number;
  netAmount: number; // amount - platformFee - processingFee
  currency: string; // 'USD'
  status: 'pending' | 'processing' | 'completed' | 'failed' | 'refunded' | 'disputed';
  paymentMethod: PaymentMethodDetails;
  stripePaymentIntentId: string;
  escrowStatus: 'held' | 'released' | 'disputed';
  escrowReleaseAt?: Date;
  metadata?: Record<string, any>;
  processedAt?: Date;
  refundedAt?: Date;
  refundAmount?: number;
  createdAt: Date;
  updatedAt: Date;
}

interface PaymentMethodDetails {
  type: 'card' | 'apple_pay' | 'google_pay';
  last4?: string;
  brand?: string;
  expiryMonth?: number;
  expiryYear?: number;
  funding?: 'credit' | 'debit' | 'prepaid';
}
```

### Stripe Integration Architecture
**Payment Processing Flow:**
```typescript
interface PaymentService {
  createPaymentIntent(params: PaymentIntentParams): Promise<PaymentIntent>;
  confirmPayment(intentId: string, paymentMethodId: string): Promise<PaymentResult>;
  processRefund(transactionId: string, amount?: number, reason?: string): Promise<RefundResult>;
  createCustomer(user: User): Promise<string>; // returns Stripe customer ID
  addPaymentMethod(customerId: string, paymentMethodId: string): Promise<void>;
  processEscrowRelease(transactionId: string): Promise<void>;
}

// Stripe payment intent creation
const createPaymentIntent = async (params: PaymentIntentParams) => {
  const { amount, currency, customerId, metadata, applicationFee } = params;

  const paymentIntent = await stripe.paymentIntents.create({
    amount: Math.round(amount * 100), // Convert to cents
    currency,
    customer: customerId,
    metadata,
    application_fee_amount: Math.round(applicationFee * 100),
    transfer_data: {
      destination: params.businessStripeAccountId
    },
    capture_method: 'manual' // For escrow functionality
  });

  return paymentIntent;
};
```

### Tax Calculation System
**Tax Service Implementation:**
```typescript
interface TaxService {
  calculateTax(params: TaxCalculationParams): Promise<TaxCalculation>;
  getTaxRates(location: BusinessLocation): Promise<TaxRates>;
  isServiceTaxable(serviceType: string, location: BusinessLocation): Promise<boolean>;
  generateTaxReport(businessId: string, period: DateRange): Promise<TaxReport>;
}

interface TaxCalculationParams {
  amount: number;
  businessLocation: BusinessLocation;
  customerLocation?: BusinessLocation;
  serviceType: string;
  productCategories?: string[];
}

interface TaxCalculation {
  subtotal: number;
  taxAmount: number;
  total: number;
  taxBreakdown: TaxBreakdownItem[];
  taxExempt: boolean;
}

// Tax calculation implementation
const calculateTax = async (params: TaxCalculationParams): Promise<TaxCalculation> => {
  const taxRates = await getTaxRates(params.businessLocation);
  const isTaxable = await isServiceTaxable(params.serviceType, params.businessLocation);

  if (!isTaxable) {
    return {
      subtotal: params.amount,
      taxAmount: 0,
      total: params.amount,
      taxBreakdown: [],
      taxExempt: true
    };
  }

  const taxAmount = params.amount * (taxRates.combinedRate / 100);

  return {
    subtotal: params.amount,
    taxAmount,
    total: params.amount + taxAmount,
    taxBreakdown: taxRates.breakdown,
    taxExempt: false
  };
};
```

### Escrow System Implementation
**Payment Escrow Logic:**
```typescript
interface EscrowService {
  holdPayment(transactionId: string, releaseConditions: EscrowConditions): Promise<void>;
  releaseEscrow(transactionId: string, releaseReason: string): Promise<void>;
  disputeEscrow(transactionId: string, disputeReason: string): Promise<void>;
  checkEscrowRelease(): Promise<void>; // Automated release processing
}

interface EscrowConditions {
  autoReleaseAfter: number; // hours
  releaseEvents: ('booking_completed' | 'pickup_confirmed' | 'manual_release')[];
  holdReasons: string[];
}

// Automatic escrow release processing
const processAutomaticEscrowReleases = async () => {
  const eligibleTransactions = await db('transactions')
    .where('escrow_status', 'held')
    .where('escrow_release_at', '<=', new Date())
    .where('status', 'completed');

  for (const transaction of eligibleTransactions) {
    try {
      await stripe.paymentIntents.capture(transaction.stripe_payment_intent_id);

      await db('transactions')
        .where('id', transaction.id)
        .update({
          escrow_status: 'released',
          processed_at: new Date()
        });

      await notificationService.sendEscrowReleaseNotification(transaction);
    } catch (error) {
      console.error(`Failed to release escrow for transaction ${transaction.id}:`, error);
    }
  }
};
```

### Frontend Payment Components
**Payment Interface Architecture:**
```typescript
interface PaymentFormProps {
  amount: number;
  currency: string;
  bookingId: string;
  onPaymentSuccess: (transaction: Transaction) => void;
  onPaymentError: (error: PaymentError) => void;
  savedPaymentMethods?: PaymentMethod[];
}

export const PaymentForm: React.FC<PaymentFormProps> = ({
  amount,
  currency,
  bookingId,
  onPaymentSuccess,
  onPaymentError,
  savedPaymentMethods
}) => {
  const [paymentMethod, setPaymentMethod] = useState<'new' | 'saved' | 'apple_pay' | 'google_pay'>('new');
  const [processing, setProcessing] = useState(false);

  const handlePayment = async (paymentDetails: PaymentDetails) => {
    setProcessing(true);

    try {
      const result = await paymentService.processPayment({
        amount,
        bookingId,
        paymentMethod: paymentDetails
      });

      if (result.status === 'succeeded') {
        onPaymentSuccess(result.transaction);
      } else {
        onPaymentError(new PaymentError(result.error));
      }
    } catch (error) {
      onPaymentError(error as PaymentError);
    } finally {
      setProcessing(false);
    }
  };

  return (
    <PaymentContainer>
      <PaymentSummary amount={amount} currency={currency} />
      <PaymentMethodSelector
        selectedMethod={paymentMethod}
        onMethodChange={setPaymentMethod}
        savedMethods={savedPaymentMethods}
      />
      <PaymentProcessingButton
        onPayment={handlePayment}
        processing={processing}
        disabled={!paymentMethod}
      />
    </PaymentContainer>
  );
};
```

### Payout System Architecture
**Business Payout Management:**
```typescript
interface PayoutService {
  calculatePayout(businessId: string, period: DateRange): Promise<PayoutCalculation>;
  createPayout(businessId: string, amount: number): Promise<Payout>;
  getPlatformFeeRate(businessId: string): Promise<number>;
  scheduleAutomaticPayouts(businessId: string, schedule: PayoutSchedule): Promise<void>;
}

interface PayoutCalculation {
  grossRevenue: number;
  platformFees: number;
  processingFees: number;
  refunds: number;
  netPayout: number;
  transactionCount: number;
  feeBreakdown: FeeBreakdownItem[];
}

// Automated payout processing
const processScheduledPayouts = async () => {
  const eligibleBusinesses = await getBusinessesWithScheduledPayouts();

  for (const business of eligibleBusinesses) {
    const payoutCalculation = await calculatePayout(business.id, getLastPayoutPeriod());

    if (payoutCalculation.netPayout > 0) {
      try {
        await stripe.transfers.create({
          amount: Math.round(payoutCalculation.netPayout * 100),
          currency: 'usd',
          destination: business.stripeAccountId,
          metadata: {
            businessId: business.id,
            period: payoutCalculation.period
          }
        });

        await recordPayoutTransaction(business.id, payoutCalculation);
      } catch (error) {
        await handlePayoutFailure(business.id, error);
      }
    }
  }
};
```

### Payment Error Handling
**Comprehensive Error Management:**
```typescript
interface PaymentError {
  code: string;
  message: string;
  type: 'card_error' | 'validation_error' | 'api_error' | 'authentication_error';
  userMessage: string;
  suggestedActions: string[];
  retryable: boolean;
}

const handlePaymentError = (stripeError: any): PaymentError => {
  const errorMap = {
    'card_declined': {
      userMessage: 'Your card was declined. Please try a different payment method.',
      suggestedActions: ['Try a different card', 'Contact your bank', 'Use a digital wallet'],
      retryable: true
    },
    'insufficient_funds': {
      userMessage: 'Your card has insufficient funds for this transaction.',
      suggestedActions: ['Try a different card', 'Add funds to your account'],
      retryable: true
    },
    'expired_card': {
      userMessage: 'Your card has expired. Please use a different payment method.',
      suggestedActions: ['Update your card expiry date', 'Use a different card'],
      retryable: false
    }
  };

  const errorInfo = errorMap[stripeError.code] || {
    userMessage: 'Payment processing failed. Please try again.',
    suggestedActions: ['Try again', 'Contact support'],
    retryable: true
  };

  return {
    code: stripeError.code,
    message: stripeError.message,
    type: stripeError.type,
    ...errorInfo
  };
};
```

### Database Schema Extensions
**Payment and Transaction Tables:**
```sql
-- Enhanced transactions table
ALTER TABLE transactions ADD COLUMN processing_fee DECIMAL(10,2) DEFAULT 0;
ALTER TABLE transactions ADD COLUMN tax_amount DECIMAL(10,2) DEFAULT 0;
ALTER TABLE transactions ADD COLUMN escrow_status VARCHAR(20) DEFAULT 'released';
ALTER TABLE transactions ADD COLUMN escrow_release_at TIMESTAMP WITH TIME ZONE;

-- Payouts tracking table
CREATE TABLE payouts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_id UUID NOT NULL REFERENCES businesses(id),
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'USD',
    stripe_transfer_id VARCHAR(255),
    status VARCHAR(20) DEFAULT 'pending',
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    transaction_count INTEGER DEFAULT 0,
    gross_revenue DECIMAL(10,2) DEFAULT 0,
    platform_fees DECIMAL(10,2) DEFAULT 0,
    processing_fees DECIMAL(10,2) DEFAULT 0,
    processed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Tax calculations table
CREATE TABLE tax_calculations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    transaction_id UUID NOT NULL REFERENCES transactions(id),
    subtotal DECIMAL(10,2) NOT NULL,
    tax_amount DECIMAL(10,2) NOT NULL,
    tax_rate DECIMAL(5,4) NOT NULL,
    tax_jurisdiction VARCHAR(255),
    calculation_details JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### Testing Requirements Context
**Payment Processing Tests:**
- `apps/api/tests/functions/payment/createIntent.test.ts`
- `apps/api/tests/services/paymentService.test.ts`
- `apps/mobile/tests/components/PaymentForm.test.tsx`

**Test Scenarios:**
- Payment intent creation and confirmation
- Escrow hold and release functionality
- Tax calculation for different business types
- Refund processing and partial refunds
- Payout calculation and distribution
- Payment error handling and recovery
- Digital wallet integration (Apple Pay, Google Pay)
- PCI compliance and security validation

### Security and Compliance Context
**PCI DSS and Security Requirements:**
- No card data storage on platform servers
- Stripe tokenization for payment method security
- SSL/TLS encryption for all payment communications
- Regular security audits and vulnerability assessments
- Compliance with data protection regulations
- Fraud detection and prevention measures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*